<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Lambda Machine</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script type="text/javascript">
    //  =====================
    //  	START Javascript
    //  =====================
    // get elements
    function $(id){
        return document.getElementById(id)
    }
    function _(msg){
        console.log(msg)
    }
    function __(msg){
        console.dir(msg)
    }
    // Checks that required APIs are operational in browser
    function checkAPIsupport(){
        _("Checking API support")
        if (window.File && window.FileReader && window.FileList && window.Blob) {
        } else {
            alert('The File APIs are not fully supported in this browser.');
        }
        _("Checking API support finished")
    }
    // posts a file to the Python web server
    function postFile(evt){
        _("Posting File ");
        var f = evt.target.files[0];
        fileName = f.name;
        _("File Name : " + fileName);
        if (!f) {
            alert("Failed to load file");
            error("Failed to load file")
        } else {
            var reader = new FileReader();
            reader.onload = (function(f) {
                return function(f) {
                    var xhr = new XMLHttpRequest;
                    _("Posting request")
                    xhr.open("POST", "/codeScrolls/" + fileName , false);
                    _("Sending request")
                    xhr.send(f.target.result); // it seems chrome only supports xhr.send which only sends strings. No binary data.
                    getScriptListing();
                };
            })(f);
            reader.readAsBinaryString(f);
        }
        _("Posting File finished");
    }
    // initializes javascript after the required HTML elements are in place
    function init(){
        _("Initializing");
        $('fileInputButton').addEventListener('change', postFile, false);
        checkAPIsupport();
        getScriptListing();
        getNodeListing();
        updatePage("scripts");
        // loops
        setInterval(getNodeListing, 5000)
        _("Initializing finished");
    }
    // console.error
    function error(str){
        console.error("<ERROR> " + str);
    }
    // color selected element
    function colorSelected(hierarchyTree, elem){
        _("Updating Content View");
        var rows = hierarchyTree.childNodes[0].getElementsByTagName("tr");
        for (i = 0; i < rows.length; i++) {
            rows[i].style.backgroundColor = "";
        }
        elem.style.backgroundColor = "lightBlue";

    }
    // called when the eye is clicked. This updates the content view div with the file's content.
    function contentView_script(fileName){
        colorSelected($('r2c1_scripts'), $(fileName))
        _("Sending request for file content view");
        xhrGet("/codeScrolls/" + fileName, function(xhr){
            var contentView_script = $('contentView_script')
            contentView_script.innerHTML = "<pre>" + xhr.response + "</pre>"
        });
        _("request for content view finished");
    }
    // node content view change
    var selectedNode=null;
    function contentView_nodes(name){
        colorSelected($('r2c1_nodes'), $(name));
        selectedNode=name;
    }
    // called when the play button is clicked. Opens the content view pannel for running the script. reaches out to Lambda-M
    function run(fileName){
        _("getting content view for running '" + fileName + "'");
        colorSelected($('r2c1_scripts'), $(fileName))
        var conView=$("contentView_script")
        xhrGet("/nodes", function (xhr) {
            listing=JSON.parse(xhr.response); // got json object of nodes // fix when omega down
            conView.innerHTML=listing;
        });
    }
    // xhr handler
    function xhrGet(loc, func){
        var xhr = new XMLHttpRequest;
        xhr.open("GET", loc, true);
        xhr.onload = function (e) {
            if(xhr.readyState == 4 && xhr.status == 200){
                func(xhr);
            }
        }
        xhr.onerror = function (e) {
            console.error(xhr.statusText);
        };
        xhr.send(null);
    }
    // updates the heirarchy view with the scripts found in the python server's codescrolls directory
    function getScriptListing(){
        // _("Getting script listing");
        xhrGet("/codeScrolls/", function (xhr) {
            var hierarchyTree = $('r2c1_scripts');
            hierarchyTree.innerHTML = xhr.response;
            var aList = [].slice.call(hierarchyTree.getElementsByTagName("a"));
            if(aList.length > 0){
                _("Found more then zero listings. Updating hierarchy view")
                var newHierarchyTree = document.createElement("table");
                for (i = 0; i < aList.length; i++) {
                    var tr  = document.createElement("tr")
                    var td1 = document.createElement("td");
                    var td2 = document.createElement("td");
                    var td3 = document.createElement("td");
                    tr.appendChild(td1);
                    tr.appendChild(td2);
                    tr.appendChild(td3);
                    newHierarchyTree.appendChild(tr)
                    // create nodes
                    var text = document.createElement("p");
                    var view = document.createElement("img");
                    var run  = document.createElement("img");
                    // text node details
                    let imgSize = 20;
                    tr  .setAttribute("id", aList[i].innerHTML);
                    text.setAttribute("style", "text-align:right;");
                    view.setAttribute("style", "text-align : left;");
                    view.setAttribute("src", "/res/view.png");
                    run .setAttribute("src", "/res/run.png");
                    run .setAttribute("width", imgSize);
                    run .setAttribute("height", imgSize);
                    view.setAttribute("width", imgSize);
                    view.setAttribute("height", imgSize);
                    run .setAttribute("onclick", "run        ('" + aList[i].innerHTML + "')");
                    view.setAttribute("onclick", "contentView_script('" + aList[i].innerHTML + "')");
                    text.innerHTML = aList[i].innerHTML;
                    // append nodes
                    td1.appendChild(view);
                    td2.appendChild(run );
                    td3.appendChild(text);
                }
                // _("Cleaning pre existing hierarchy tree")
                while (hierarchyTree.firstChild) {
                    hierarchyTree.removeChild(hierarchyTree.firstChild);
                }
                hierarchyTree.appendChild(newHierarchyTree);
            }else{
                hierarchyTree.innerHTML = "<p style='text-align:center'>Uploaded Files Will Appear Here.</p>"
            }
            _("Got new script listing");
        });
    }
    // updates the heirarchy view with the scripts found in the python server's codescrolls directory
    function getNodeListing(){
        SecondsToNodeLoss=100
        // _("Getting node listing");
        xhrGet("/nodes", function (xhr) {
            var hierarchyTree = $('r2c1_nodes');
            listing=JSON.parse(xhr.response); // got json object of nodes // fix when omega down
            // _("Nodes Found: ")
            // __(listing)
            var newHierarchyTree = document.createElement("table");
            var epochTime = (new Date).getTime();
            listing.forEach(function(element, index, array){
                // create table elements
                var tr  = document.createElement("tr")
                var td_view  = document.createElement("td");
                var td_text  = document.createElement("td");
                var td2_stat = document.createElement("td");
                // append elements
                tr.appendChild(td_view);
                tr.appendChild(td2_stat);
                tr.appendChild(td_text);
                newHierarchyTree.appendChild(tr)
                // create internal elements
                var text = document.createElement("p");
                var view = document.createElement("img");
                var stat = document.createElement("div");
                // setup internal html elements
                let imgSize = "20px";
                tr  .setAttribute("id", element.name);
                text.setAttribute("style", "text-align: left;");
                view.setAttribute("style", "text-align : left;");
                view.setAttribute("src", "/res/view.png");
                view.setAttribute("width", imgSize);
                view.setAttribute("height", imgSize);
                stat.setAttribute("class",      "circle");
                // status indicator
                deltaT=Math.floor(epochTime/1000-element.time);
                redFactor=deltaT/SecondsToNodeLoss;
                if(redFactor > 1){
                    redFactor = 1;
                }
                red     = Math.floor(255 * redFactor)
                green   = Math.floor(255 * (1-redFactor) )
                stat.style.background="rgb("+red+","+green+",0)"
                // text field
                text.innerHTML = element.name;
                text.style.width="100%"
                view.setAttribute("onclick", "contentView_nodes('" + element.name + "')");
                td_view.appendChild(view);
                td_text.appendChild(text);
                td2_stat.appendChild(stat);
            });
            // _("Cleaning pre existing hierarchy tree")
            while (hierarchyTree.firstChild) {
                hierarchyTree.removeChild(hierarchyTree.firstChild);
            }
            hierarchyTree.appendChild(newHierarchyTree);
            if(selectedNode){
                colorSelected($('r2c1_nodes'), $(selectedNode));
            }
            _("Got new node listing");
        });
    }
    // change view
    function updatePage(page){
        var pages=[$("nodes"),$("debug"),$("scripts"),$("progs"),$("data")];
        pages.forEach(function(element, index, array){
            element.style.visibility= "hidden";
        });
        $(page).style.visibility= "visible";
    }
    //  =====================
    //  	END Javascript
    //  =====================
    </script>
</head>

<body>
    <div id="r1">
        <table id="menuTable">
            <tr>
                <td>
                    <div class="menuButton" style="border-style: none;max-height:10av;"> <!-- logo -->
                        <!-- <img src="res/logo.png" alt="logo" style="max-width:100%;max-height:100%;"> -->
                    </div>
                </td>
                <td><button class="menuButton" type="button" onclick="updatePage('scripts')">Scripts</button></td>
                <td><button class="menuButton" type="button" onclick="updatePage('nodes')">Nodes</button></td>
                <td><button class="menuButton" type="button" onclick="updatePage('progs')">Progs</button></td>
                <td><button class="menuButton" type="button" onclick="updatePage('data')">Data</button></td>
                <td><button class="menuButton" type="button" onclick="updatePage('debug')">Debug</button></td>
            </tr>
        </table>
    </div>

    <!--    =====================
    Node Div
    ===================== -->
    <div id="nodes" >
        <div id="r2_nodes" class="r2">
            <div id="r2c1_nodes" class="r2c1">
                <p style='text-align:center'>Node Listing will appear here.</p>
            </div>
            <div id="r2c2_nodes" class="r2c2">
                <div id="contentView_nodes" class="contentView">
                    <p style='text-align:center'>Node information will appear here.</p>
                </div>
            </div>
        </div>
    </div>
    <!--    =====================
    Progs Div
    ===================== -->
    <div id="progs" >
        <div id="r2_progs" class="r2">
            <div id="r2c1_progs" class="r2c1">
                <p style='text-align:center'>Progs Listing will appear here.</p>
            </div>
            <div id="r2c2_progs" class="r2c2">
                <div id="contentView_progs" class="contentView">
                    <p style='text-align:center'>Progs information will appear here.</p>
                </div>
            </div>
        </div>
    </div>
    <!--    =====================
    database Div
    ===================== -->
    <div id="data" >
        <div id="r2_data" class="r2">
            <div id="r2c1_data" class="r2c1">
                <p style='text-align:center'>Database info will appear here.</p>
            </div>
            <div id="r2c2_data" class="r2c2">
                <div id="contentView_data" class="contentView">
                    <p style='text-align:center'>Database info will appear here.</p>
                </div>
            </div>
        </div>
    </div>
    <!--    =====================
    Debug Div
    ===================== -->
    <div id="debug" >
    </div>

    <!--    =====================
    Script Div
    ===================== -->
    <div id="scripts" >
        <div id="r2_scripts" class="r2">
            <div id="r2c1_scripts" class="r2c1">
                <p style='text-align:center'>Script Listing will appear here.</p>
            </div>
            <div id="r2c2_scripts" class="r2c2">
                <div id="fileInputButtonDiv">
                    <p id="fileInputButtonP">Drop a script or click here to upload! (Text Only)</p>
                    <input type="file" id="fileInputButton">
                </div>
                <div id="contentView_script" class="contentView">
                    <p style='text-align:center'>Program Content will appear here (upload a file and click the eye)</p>
                </div>
            </div>
        </div>
    </div>

    <script> init();	</script>
</body>

</html>
